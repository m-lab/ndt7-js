language: node_js

node_js:
- 12

# Required by TestCafe.
before_install:
   - stty cols 80

addons:
   firefox: latest
   chrome: stable

script:
# Coverage runs the tests, so this implies `npm test`
# TODO: upload coverage to coveralls.io
- npm run coverage
# Lint the code. Note that the linter version is saved in
# package-lock.json, which means that eslint on the host and the server
# should be exactly the same.
- npm run lint
# Verify that the things that are compiled and checked in have been
# generated correctly from the most recent sources.
- npm run document && git diff --exit-code README.md
- npm run minify && git diff --exit-code src/ndt7.min.js

# Set up BrowserStackLocal so that BrowserStack can access the local server.
- wget https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip
- unzip BrowserStackLocal-linux-x64.zip
- export BROWSERSTACK_LOCAL_IDENTIFIER="TestCafe"
# --parallel-runs is set to the maximum parallel runs allowed by our plan.
- ./BrowserStackLocal --key $BROWSERSTACK_ACCESS_KEY --local-identifier $BROWSERSTACK_LOCAL_IDENTIFIER --daemon start --parallel-runs 5
- npm run browserstack
- ./BrowserStackLocal --key $BROWSERSTACK_ACCESS_KEY --local-identifier TestCafe --daemon stop
# TODO Upload the code to npm after it is tagged.
